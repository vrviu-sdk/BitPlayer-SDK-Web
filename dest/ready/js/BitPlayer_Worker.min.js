var videoList,index_num,index2;const trun=1953658222,MOV_TRUN_DATA_OFFSET=1,MOV_TRUN_FIRST_SAMPLE_FLAGS=4,MOV_TRUN_SAMPLE_DURATION=256,MOV_TRUN_SAMPLE_SIZE=512,MOV_TRUN_SAMPLE_FLAGS=1024,MOV_TRUN_SAMPLE_CTS=2048,mdat=1835295092,avcC=1635148611,sidx=1936286840;var Orientation,viewVector,m_Yaw=0,m_Pitch=0,m_Roll=0,viewers={0:{y:0,p:0,r:0,value:"e"},1:{y:0,p:45,r:0,value:"m"},2:{y:0,p:-45,r:0,value:"6"},3:{y:0,p:90,r:0,value:"q"},4:{y:0,p:-90,r:0,value:"1"},5:{y:45,p:0,r:0,value:"f"},6:{y:-45,p:0,r:0,value:"d"},7:{y:45,p:45,r:0,value:"n"},8:{y:45,p:-45,r:0,value:"7"},9:{y:-45,p:45,r:0,value:"l"},10:{y:-45,p:-45,r:0,value:"5"},11:{y:90,p:0,r:0,value:"g"},12:{y:-90,p:0,r:0,value:"c"},13:{y:90,p:45,r:0,value:"o"},14:{y:90,p:-45,r:0,value:"8"},15:{y:-90,p:45,r:0,value:"k"},16:{y:-90,p:-45,r:0,value:"4"},17:{y:135,p:0,r:0,value:"h"},18:{y:-135,p:0,r:0,value:"b"},19:{y:135,p:45,r:0,value:"p"},20:{y:135,p:-45,r:0,value:"9"},21:{y:-135,p:45,r:0,value:"j"},22:{y:-135,p:-45,r:0,value:"3"},23:{y:-180,p:0,r:0,value:"a"},24:{y:-180,p:45,r:0,value:"i"},25:{y:-180,p:-45,r:0,value:"2"}};function copy_turn(n,e,t){var i=0;t&&(i=1);var a=new Uint8Array(e.data.buffer);(a=a.slice(e.turn_inx+e.nalu[i].trun_offset,e.mdat_inx)).forEach(function(e,t){n.push(e)})}function copy_nalu(n,e){var t=new Uint8Array(e.data.buffer);(t=t.slice(e.nalu[0].mdat_address,t.length)).forEach(function(e,t){n.push(e)})}function ajax(n,e){var t=new XMLHttpRequest;if(n){t.open("GET",n),t.send(),t.responseType="arraybuffer";try{t.addEventListener("readystatechange",function(){if(t.readyState==t.DONE)try{e(t.response)}catch(n){console.log("Exception while appending initialization content",n)}},!1)}catch(n){console.log(n)}}}function http(n,e,t,i){return new Promise(function(a,r){var o=new XMLHttpRequest;if(o.responseType="arraybuffer",o.open(e,n,!0),i)for(var u in i)o.setRequestHeader(u,i[u]);o.addEventListener("readystatechange",function(n){4===o.readyState&&(String(o.status).match(/^2\d\d$/)?a(o.response):r(o),o.onreadystatechange=null,o=null)}),o.send(t)})}function mergeBuffer2(n,e){(videoList={})[index2]||(videoList[index2]={}),videoList[index2][index_num]={};var t=http(domain+n,"GET",null).then(function(n){videoList[index2][index_num].layer0=n}),i=http(domain+e,"GET",null).then(function(n){videoList[index2][index_num].audio0=n});Promise.all([t,i]).then(function(n){videoList[index2][index_num].totalVideo=new Uint8Array(videoList[index2][index_num].layer0),index_num+=1;var e=(new Date).getTime();postMessage({videoList:videoList,index_num:index_num,index2:index2,timestamp:e})})}function mergeBuffer(n,e,t,i,a){(videoList={})[index2]||(videoList[index2]={}),videoList[index2][index_num]={};var r=http(domain+n,"GET",null).then(function(n){videoList[index2][index_num].layer0=n}),o=http(domain+e,"GET",null).then(function(n){videoList[index2][index_num].layer1=n}),u=http(domain+t,"GET",null).then(function(n){videoList[index2][index_num].layer2=n}),d=http(domain+i,"GET",null).then(function(n){videoList[index2][index_num].layer3=n}),_=http(domain+a,"GET",null).then(function(n){videoList[index2][index_num].audio0=n});Promise.all([r,o,u,d,_]).then(function(n){videoList[index2][index_num].totalVideo=new Uint8Array(assembly(videoList[index2][index_num].layer0,videoList[index2][index_num].layer1,videoList[index2][index_num].layer2,videoList[index2][index_num].layer3));(new Date).getTime();index_num+=1;var e=(new Date).getTime();postMessage({videoList:videoList,index_num:index_num,index2:index2,timestamp:e})})}function assembly(n,e,t,i){var a,r,o,u,d,_=[],l=[];d=(a=find_nalu(n,_)).nalu[0].length+8;for(var s=(r=find_nalu(e,_=[])).nalu_number-1;s>=0;s--)d+=r.nalu[s].length;for(var m=(o=find_nalu(t,_=[])).nalu_number-1;m>=0;m--)d+=o.nalu[m].length;for(var v=(u=find_nalu(i,_=[])).nalu_number-1;v>=0;v--)d+=u.nalu[v].length;l[0]=d>>24,l[1]=d>>16&255,l[2]=d>>8&255,l[3]=255&d,l[4]=109,l[5]=100,l[6]=97,l[7]=116;var c=[];new Uint8Array(a.data.buffer).slice(0,a.turn_inx+a.nalu[1].trun_offset).forEach(function(n,e){c.push(n)}),copy_turn(c,r,1),copy_turn(c,o,0),copy_turn(c,u,0);for(var f=0;f<l.length;f++)c.push(l[f]);return new Uint8Array(a.data.buffer).slice(a.nalu[0].mdat_address,a.nalu[0].mdat_address+a.nalu[0].length).forEach(function(n,e){c.push(n)}),copy_nalu(c,r),copy_nalu(c,o),copy_nalu(c,u),a=null,r=null,o=null,u=null,c}function find_nalu(n,e){var t=new DataView(n),i=seek_box(t,trun),a=mini_gop_gothrough_trun(t,i,e),r=seek_box(t,mdat);if(r>0){e[0].mdat_address=r+8,e[0].type=t.getUint8(e[0].mdat_address+4);for(var o=1;o<a;o++)e[o].mdat_address=e[o-1].mdat_address+e[o-1].length,e[o].mdat_address+4<t.byteLength&&(e[o].type=t.getUint8(e[o].mdat_address+4))}return{turn_inx:i,nalu_number:a,mdat_inx:r,nalu:e,data:t}}function seek_box(n,e){for(var t=0,i=0;i<n.byteLength;i++)if((t=t<<8|n.getUint8(i))==e)return i-7;return-1}function mini_gop_gothrough_trun(n,e,t){var i=e+4,a=n.getUint32(i);i+=4;var r=0;if(a==trun){i++;var o,u=n.getUint8(i)<<16|n.getUint8(i+1)<<8|n.getUint8(i+2);if(i+=3,r=n.getUint32(i),i+=4,r>35)return-1;for(u&MOV_TRUN_DATA_OFFSET&&(i+=4),u&MOV_TRUN_FIRST_SAMPLE_FLAGS&&(i+=4),o=0;o<r;o++)u&MOV_TRUN_SAMPLE_DURATION&&(i+=4),u&MOV_TRUN_SAMPLE_SIZE&&(t[o]={},t[o].trun_offset=i-e,t[o].length=n.getUint32(i),i+=4),u&MOV_TRUN_SAMPLE_FLAGS&&(i+=4),u&MOV_TRUN_SAMPLE_CTS&&(i+=4);u&MOV_TRUN_SAMPLE_FLAGS&&(i+=4),u&MOV_TRUN_SAMPLE_CTS&&(i+=4)}return r}function getViewVector(){return rotateVector([0,0,-1])}function rotateVector(n){var e=-Orientation.m_Roll*Math.PI/180,t=Orientation.m_Pitch*Math.PI/180,i=-Orientation.m_Yaw*Math.PI/180,a=[Math.cos(e)*n[0]+Math.sin(e)*n[1],-Math.sin(e)*n[0]+Math.cos(e)*n[1],n[2]],r=[a[0],Math.cos(t)*a[1]+Math.sin(t)*a[2],-Math.sin(t)*a[1]+Math.cos(t)*a[2]];return[Math.cos(i)*r[0]+Math.sin(i)*r[2],r[1],-Math.sin(i)*r[0]+Math.cos(i)*r[2]]}function getIndexOvarfAdaptationSetWithClosestView(){var n=1.7;for(var e in viewers){Orientation.m_Roll=viewers[e].r,Orientation.m_Pitch=viewers[e].p,Orientation.m_Yaw=viewers[e].y;var t=distance({});t<n&&(n=t,index2=e,m_Yaw=Orientation.m_Yaw,m_Pitch=Orientation.m_Pitch,m_Roll=Orientation.m_Roll)}2==algorithm?mergeBuffer2(domain+".20001100"+viewers[index2].value+"02s_"+index_num+".m4s",domain+".30001100"+viewers[index2].value+"02t_"+index_num+".m4s"):mergeBuffer(domain+"m4s/y360p360r360/y360p360r360_"+(index_num-1)+"_1_0.m4s",domain+"m4s/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"_"+(index_num-1)+"_3_0.m4s",domain+"m4s/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"_"+(index_num-1)+"_3_1.m4s",domain+"m4s/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"/y"+m_Yaw+"p"+m_Pitch+"r"+m_Roll+"_"+(index_num-1)+"_3_2.m4s",domain+"m4s/audio/audio_"+(index_num-1)+"_1_0.m4s")}function distance(n){var e=getViewVector(),t=[viewVector[0]-e[0],viewVector[1]-e[1],viewVector[2]-e[2]];return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}onmessage=function(n){videoList=n.data.videoList,index2=n.data.index2,index_num=n.data.index_num,Orientation=n.data.Orientation,domain=n.data.domain,algorithm=n.data.algorithm,viewVector=getViewVector(),getIndexOvarfAdaptationSetWithClosestView()};